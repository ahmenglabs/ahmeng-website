---
import Main from "@/layouts/Main.astro";
import Layout from "@/layouts/Layout.astro";
import Header from "@/components/Header.astro";
import Footer from "@/components/Footer.astro";
import { SITE } from "@/config";
import { getCollection } from "astro:content";
import getSortedPosts from "@/utils/getSortedPosts";
import { getPath } from "@/utils/getPath";

const posts = await getCollection("blog", ({ data }) => !data.draft);
const sortedPosts = getSortedPosts(posts).map(post => ({
  ...post,
  slug: getPath(post.id, post.filePath, false),
}));

const backUrl = SITE.showBackButton ? `${Astro.url.pathname}` : "/";
---

<Layout title={`Search | ${SITE.title}`}>
  <Header />
  <Main pageTitle="Search" pageDesc="Search any article ...">
    <div id="search-container" transition:persist data-backurl={backUrl}></div>
  </Main>
  <Footer />
</Layout>

<script define:vars={{ posts: sortedPosts }}>
  import Fuse from "fuse.js";

  const fuse = new Fuse(posts, {
    keys: ["data.title", "data.description", "data.tags"],
    threshold: 0.3,
  });

  function initSearch() {
    const container = document.querySelector("#search-container");

    if (!container) return;

    const params = new URLSearchParams(window.location.search);
    const query = params.get("q") || "";

    container.innerHTML = `
      <div class="mb-4">
        <input type="text" id="search-input" class="w-full p-2 border border-gray-300 rounded" placeholder="Search articles..." value="${query}">
        <button id="search-button" class="mt-2 px-4 py-2 bg-blue-500 text-white rounded">Search</button>
      </div>
      <div id="results"></div>
    `;

    const input = document.querySelector("#search-input");
    const button = document.querySelector("#search-button");
    const resultsDiv = document.querySelector("#results");

    function performSearch() {
      const term = input.value.trim();
      if (term) {
        params.set("q", term);
        history.replaceState(history.state, "", "?" + params.toString());
        const results = fuse.search(term);
        displayResults(results);
      } else {
        params.delete("q");
        history.replaceState(history.state, "", window.location.pathname);
        resultsDiv.innerHTML = "";
      }
    }

    button.addEventListener("click", performSearch);
    input.addEventListener("input", () => {
      if (!input.value.trim()) {
        params.delete("q");
        history.replaceState(history.state, "", window.location.pathname);
        resultsDiv.innerHTML = "";
      }
    });

    if (query) {
      performSearch();
    }
  }

  function displayResults(results) {
    const resultsDiv = document.querySelector("#results");
    if (results.length === 0) {
      resultsDiv.innerHTML = "<p>No results found.</p>";
      return;
    }
    resultsDiv.innerHTML = results
      .map(result => {
        const post = result.item;
        return `
        <div class="mb-4 p-4 border rounded">
          <h3><a href="/posts/${post.slug}" class="text-blue-600">${post.data.title}</a></h3>
          <p>${post.data.description}</p>
          <p>Tags: ${post.data.tags ? post.data.tags.join(", ") : ""}</p>
        </div>
      `;
      })
      .join("");
  }

  document.addEventListener("astro:after-swap", initSearch);
  initSearch();
</script>

<style is:global>
  #search-container {
    /* Add styles if needed */
  }
</style>
